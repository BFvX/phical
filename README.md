# phical - Phigros Calculator
Phigros的糊A小助手（DEMO阶段） 目前只适用于课题模式，且bug一堆

只是个编了两天的个人兴趣项目

写的很烂，求轻喷……

文档在编了（咕

## 感谢列表
* 灵感来源：[【phigros】你的糊A小助手](https://www.bilibili.com/video/BV1WL41147Lo)
* 部分代码参考/借用：[kvarenzn/phisap](https://github.com/kvarenzn/phisap)

## 项目简介
本项目灵感来源于上文提及视频，理论功能应当包括：
- 当前判定结果计算
- 当前准度计算
- 当前分数理论值计算
- 最终分数与等级估计
- ……

本项目也可能包括以下扩展功能（在做了在做了）：
- 打歌结果分析
- 个人水平统计
- 以上项目的可视化
- 收歌教学（？）
- ……

实现方式包括但不限于OCR、增强学习（将不可能出现在本项目中（）等。**对于课题模式**，具体实现方式为解以下方程组：

$$perfect+good+bad=pass$$

$$\frac{perfect+0.65 good}{numOfNotes}=\frac{score}{1e6}$$

但由于变量个数多于方程数，需要遍历 $bad$ 进行测试，这种开销在OCR识别不准确（$bad$ 遍历启动需要固定为0）以及连击分存在（需要同时代入连击数进行测试）的情况下更为明显。
## 暂时存在的问题
- 目前（为了图省事）使用的OCR工具（tesseract）并非专用于数字串识别，其识别数字的准度和效率较低，因此导致：
    - 仅考虑OCR识别速度已经无法实现即时检测
    - 识别结果有误，导致判定计算结果异常，进而导致抽帧
    - 暂时未编写OCR识别结果保存的代码，重复测试可能导致浪费大量的时间，因此保证测试时先识别少数几张图片以保证程序能挣产运销
    - ……
- 考虑到时间限制，目前判定计算算法仅适用于课题模式，即没有连击分计算的情况。理论上目前算法经过一定修改应当可以应用于普通模式，但由于多种原因可能会影响计算效率，在当前推送暂未加入
- 由于游戏中的判定存在一定的正负范围，可能会影响判定结果计算，目前采用以下方案暂时缓解：
    - 第一个note尽可能取得perfect，便于判定时间轴对齐
    - 尽量选取note不太密集的谱，或者含有一定的休息段便于修正
    - 程序采用当前判断的前后判定信息进行一定程度的修正
- 程序中（为了图省事）大量采用了`try: ... except ...: ...`的结构，可能导致潜在的BUG

## 使用方式
0. 请抱着会失望的心情开始测试，无需对此项目抱有太大期望（
1. 安装`requirements.txt`中的依赖库
2. 安装并配置OCR支持（`tesseract`），请参考搜索引擎
3. 去Phigros录制一段课题模式的打歌视频，由于项目仍处于DEMO阶段，请保证打歌过程没有暂停，切出的情况，或自行修改程序保证对齐。同时基于以上提及BUG，请选取合适的谱面
4. 使用软件或插件（Premier、OpenCV、PotPlayer等）截取一定帧速率下的（仅包含分数）截图（当然，您也可以利用cv2库直接读取视频流），存放于项目目录下的img文件夹中（推荐帧速率为11.988fps左右，帧速率过高或过低可能会影响计算准确度，并可能需要修改`ocr.py`文件）。取得截图前，须获得实际视频中第一个音符的判定时间，尽量靠近perfect判定范围
5. 修改`ocr.py`文件中的文件名，必要时同时修改文件名匹配功能的对应代码
6. 使用`main.py`或`cv2test.ipynb`进行测试，当前commit内`main.py`仅有控制台输出，`cv2test.ipynb`包含了简单的导出为视频的demo（仅供参考），其余主体代码基本一致，因此推荐使用`ipynb`
7. 若导出了视频，可以用剪辑软件使得导出视频与原视频同步以获得更好的观感，以第一个note为判定同步标志，在此附近微调即可

## 测试案例
### DEMO-1：狂喜蘭舞.LeaF.0.Chart_HD
这个HD谱可以算是比较符合选谱规则的，谱面中间部分与最后都有充足的时间用来进行判定修正，因此测试结果也相对较为准确。结束时识别截图如下：

### DEMO-2：望影の方舟Six.SeURa.0.Chart_IN